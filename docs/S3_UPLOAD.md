# S3 资源上传功能说明

## 概述

思源分享插件现已支持将文档中的图片和附件自动上传到 S3 兼容的对象存储服务，并在分享时使用 S3 链接替换本地资源路径，从而提升分享内容的访问速度和可靠性。

## 功能特性

### 1. S3 配置
- **完整的 S3 配置支持**：端点、区域、存储桶、访问密钥
- **自定义 CDN 域名**：支持使用 CDN 加速域名访问资源
- **路径前缀设置**：便于组织和管理存储对象
- **本地安全存储**：所有配置仅保存在本机，不上传到服务器

### 2. 资源处理
- **自动检测资源**：从 Markdown 内容中自动提取图片和附件链接
- **智能去重**：基于文件哈希值避免重复上传相同资源
- **批量上传**：支持一次性上传多个资源文件
- **链接替换**：自动将本地路径替换为 S3 URL

### 3. 资源记录管理
- **本地映射记录**：保存文档与 S3 资源的映射关系
- **后端持久化**：将资源信息传递给后端进行持久化存储
- **增量更新**：支持文档更新时的增量资源处理

## 配置说明

### 前置条件
1. 一个 S3 兼容的对象存储服务（AWS S3、阿里云 OSS、腾讯云 COS、MinIO 等）
2. 已创建的存储桶，并配置了公共读权限
3. 访问密钥（Access Key ID 和 Secret Access Key）

### 配置步骤

1. 打开插件设置
2. 切换到 "☁️ S3 存储配置" 标签页
3. 填写以下配置项：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| 启用 S3 存储 | 开启后才会上传资源到 S3 | 勾选 |
| S3 端点地址 | S3 服务的端点 URL | `s3.amazonaws.com` 或 `oss-cn-hangzhou.aliyuncs.com` |
| 区域 (Region) | 存储桶所在区域 | `us-east-1` 或 `cn-hangzhou` |
| 存储桶 (Bucket) | 用于存储资源的桶名称 | `my-siyuan-share` |
| Access Key ID | S3 访问密钥 ID | `AKI***` |
| Secret Access Key | S3 访问密钥 | `***` |
| 自定义 CDN 域名 | （可选）CDN 加速域名 | `https://cdn.example.com` |
| 路径前缀 | （可选）对象路径前缀 | `siyuan-share` |

4. 保存配置

## 使用流程

### 分享时自动上传

1. 配置好 S3 存储后，正常创建分享
2. 插件会自动：
   - 扫描文档内容，提取所有本地资源链接
   - 从思源笔记获取资源文件
   - 计算文件哈希值，检查是否已上传（去重）
   - 将新资源上传到 S3
   - 替换 Markdown 内容中的资源链接为 S3 URL
   - 保存资源映射记录到本地
   - 将资源信息传递给后端持久化

### 资源路径处理

插件会自动处理以下格式的资源引用：

```markdown
# Markdown 图片语法
![图片描述](assets/image.png)

# Markdown 链接语法
[附件下载](assets/document.pdf)

# HTML img 标签
<img src="assets/photo.jpg" />
```

上传后会自动替换为：

```markdown
![图片描述](https://your-bucket.s3.amazonaws.com/siyuan-share/1699999999999-abc123def456.png)
```

## 技术实现

### 文件命名
- 格式：`{pathPrefix}/{timestamp}-{hash}.{ext}`
- 示例：`siyuan-share/1699999999999-abc123def456.png`
- 优势：时间戳保证唯一性，哈希值用于去重

### 去重机制
1. 计算文件 SHA-256 哈希值（取前16位）
2. 在本地记录中查找相同哈希的文件
3. 如已存在，直接使用已有的 S3 URL，跳过上传

### 数据结构

#### AssetUploadRecord（资源上传记录）
```typescript
{
  localPath: string;      // 本地路径
  s3Key: string;          // S3 对象键名
  s3Url: string;          // S3 访问 URL
  contentType: string;    // MIME 类型
  size: number;           // 文件大小
  hash: string;           // 文件哈希
  uploadedAt: number;     // 上传时间戳
}
```

#### DocAssetMapping（文档资源映射）
```typescript
{
  docId: string;          // 文档 ID
  shareId: string;        // 分享 ID
  assets: AssetUploadRecord[];
  createdAt: number;
  updatedAt: number;
}
```

### 本地存储
- 存储键：`asset-mappings`
- 格式：JSON 数组
- 持久化：自动保存到插件数据目录

### 后端集成
分享创建请求会包含 `assets` 字段，后端可选择：
1. 保存资源映射信息
2. 用于分享内容的缓存和管理
3. 统计资源使用情况

## 注意事项

### 安全性
1. **访问密钥保护**：Access Key 和 Secret Key 仅保存在本机，不上传到分享服务器
2. **存储桶权限**：建议设置为"公共读，私有写"，仅允许授权上传
3. **CDN 域名**：如使用 CDN，确保配置了正确的 CORS 和缓存策略

### 成本考虑
1. **存储费用**：根据上传的资源大小和数量计费
2. **流量费用**：每次访问分享页面会产生 S3 出站流量
3. **请求费用**：上传和访问会产生 API 请求费用
4. **CDN 费用**：如使用 CDN 会额外产生 CDN 费用

建议：
- 定期清理过期分享的资源
- 使用 CDN 减少直接访问 S3 的流量
- 设置对象生命周期规则自动删除过期文件

### 兼容性
1. **S3 兼容性**：支持 AWS S3、阿里云 OSS、腾讯云 COS、MinIO 等
2. **签名版本**：已实现完整的 AWS Signature V4 签名算法，兼容所有 S3 服务
3. **资源类型**：支持图片、视频、音频、文档等各种类型文件

### 故障处理
1. **上传失败**：如果资源上传失败，分享会继续使用原始内容（不中断分享流程）
2. **部分失败**：批量上传时，部分文件失败会显示错误提示，成功的文件仍会替换链接
3. **网络超时**：大文件上传可能超时，建议压缩图片或分批上传

## 未来计划

- [x] 支持完整的 AWS Signature V4 签名 ✅
- [ ] 支持断点续传
- [ ] 支持资源压缩（图片自动压缩）
- [ ] 支持批量删除 S3 资源
- [ ] 支持资源使用统计
- [ ] 支持多个 S3 配置切换
- [ ] 支持其他对象存储协议（WebDAV、FTP 等）

## 常见问题

### Q: 上传失败，提示 CORS 错误？
A: 需要在 S3 存储桶配置 CORS 策略，允许来自思源笔记的跨域请求。

### Q: 已上传的资源如何删除？
A: 当前版本需要手动登录 S3 控制台删除。未来版本会支持插件内批量删除。

### Q: 支持哪些对象存储服务？
A: 支持所有 S3 兼容的服务，包括：
- AWS S3
- 阿里云 OSS
- 腾讯云 COS
- 华为云 OBS
- 七牛云 Kodo
- 又拍云
- MinIO（自建）
- Ceph RGW（自建）

### Q: 可以使用国内的对象存储吗？
A: 可以，配置时填写对应服务商的端点和区域即可。

### Q: 资源上传后能修改吗？
A: 当前版本不支持修改已上传的资源。如需更新，建议重新分享文档。

## 技术支持

如遇到问题或有建议，欢迎：
1. 提交 GitHub Issue
2. 在社区论坛反馈
3. 查看插件日志（开发者工具控制台）
